<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Host System Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-server"></i> Multi-Host System Monitor
            </span>
            <span class="navbar-text">
                <i class="fas fa-chart-line"></i> 
                Infrastructure Health: {{ overall_status.health_percentage }}%
                ({{ overall_status.online }}/{{ overall_status.total }} online)
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Overall Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Hosts</h5>
                        <h2>{{ overall_status.total }}</h2>
                        <p class="card-text">Monitored Systems</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Online</h5>
                        <h2>{{ overall_status.online }}</h2>
                        <p class="card-text">Active Systems</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Offline</h5>
                        <h2>{{ overall_status.offline }}</h2>
                        <p class="card-text">Unreachable Systems</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h5 class="card-title">Errors</h5>
                        <h2>{{ overall_status.errors }}</h2>
                        <p class="card-text">Systems with Errors</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hosts Grid -->
        <div class="row">
            {% for host_id, host in hosts.items() %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100 {% if host.status == 'online' %}border-success{% elif host.status == 'offline' %}border-warning{% elif host.status == 'timeout' %}border-warning{% else %}border-danger{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-{% if host.info.type == 'windows' %}windows{% else %}linux{% endif %}"></i>
                            {{ host.info.name }}
                        </h5>
                        <span class="badge bg-{% if host.status == 'online' %}success{% elif host.status == 'offline' or host.status == 'timeout' %}warning{% else %}danger{% endif %}">
                            {{ host.status.upper() }}
                        </span>
                    </div>
                    <div class="card-body">
                        <!-- Host Info -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>IP:</strong><br>
                                <span class="text-muted">{{ host.info.ip }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Last Update:</strong><br>
                                <span class="text-muted">
                                    {% if host.last_update %}
                                        {{ host.last_update.strftime('%H:%M:%S') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        {% if host.status == 'online' and host.data %}
                        <!-- Resource Usage -->
                        <div class="row mb-3">
                            <div class="col-4 text-center">
                                <div class="text-primary">
                                    <i class="fas fa-microchip"></i><br>
                                    <strong>{{ "%.1f"|format(host.cpu_usage) }}%</strong><br>
                                    <small>CPU</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="text-success">
                                    <i class="fas fa-memory"></i><br>
                                    <strong>{{ "%.1f"|format(host.memory_usage) }}%</strong><br>
                                    <small>Memory</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="text-warning">
                                    <i class="fas fa-hdd"></i><br>
                                    <strong>{{ "%.1f"|format(host.disk_usage) }}%</strong><br>
                                    <small>Disk</small>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bars -->
                        <div class="mb-2">
                            <small>CPU Usage</small>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar {% if host.cpu_usage > 80 %}bg-danger{% elif host.cpu_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                     data-width="{{ host.cpu_usage }}" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Memory Usage</small>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar {% if host.memory_usage > 80 %}bg-danger{% elif host.memory_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                     data-width="{{ host.memory_usage }}" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small>Disk Usage</small>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar {% if host.disk_usage > 90 %}bg-danger{% elif host.disk_usage > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                                     data-width="{{ host.disk_usage }}" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">Processes</small><br>
                                <strong>{{ host.active_processes }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Uptime</small><br>
                                <strong>{{ host.uptime_days }}d</strong>
                            </div>
                        </div>

                        <!-- Alerts -->
                        {% if host.alerts %}
                        <div class="mt-3">
                            {% for alert in host.alerts %}
                            <div class="alert alert-{{ alert.type }} py-1 px-2 mb-1" style="font-size: 0.85em;">
                                <i class="fas fa-exclamation-triangle"></i> {{ alert.message }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% else %}
                        <!-- Offline Status -->
                        <div class="text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>
                                {% if host.status == 'offline' %}
                                    Host is niet bereikbaar
                                {% elif host.status == 'timeout' %}
                                    Verbinding timeout
                                {% elif host.status == 'error' %}
                                    Fout bij ophalen data
                                {% else %}
                                    Status onbekend
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <a href="{{ url_for('host_detail', host_id=host_id) }}" 
                           class="btn btn-primary btn-sm {% if host.status != 'online' %}disabled{% endif %}">
                            <i class="fas fa-eye"></i> Details
                        </a>
                        {% if host.status != 'online' %}
                        <button onclick="retryHost('{{ host_id }}')" 
                                class="btn btn-warning btn-sm ms-2" 
                                id="retry-btn-{{ host_id }}">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                        {% endif %}
                        <small class="text-muted ms-2">{{ host.info.type|title }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button onclick="refreshAll()" class="btn btn-outline-success me-2">
                            <i class="fas fa-sync-alt"></i> Refresh All Hosts
                        </button>
                        <a href="/logs" class="btn btn-outline-warning me-2">
                            <i class="fas fa-file-alt"></i> Live Logs
                        </a>
                        <a href="/api/hosts" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-code"></i> View API Data
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        function refreshAll() {
            location.reload();
        }
        
        function retryHost(hostId) {
            const button = document.getElementById('retry-btn-' + hostId);
            const originalContent = button.innerHTML;
            
            // Update button to show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retrying...';
            button.disabled = true;
            
            fetch('/api/retry/' + hostId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'online') {
                        // Host is back online, show success and refresh page
                        button.innerHTML = '<i class="fas fa-check"></i> Online!';
                        button.className = 'btn btn-success btn-sm ms-2';
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        // Still offline, revert button
                        button.innerHTML = originalContent;
                        button.disabled = false;
                        
                        // Show temporary feedback
                        button.innerHTML = '<i class="fas fa-times"></i> Still Offline';
                        button.className = 'btn btn-danger btn-sm ms-2';
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                            button.className = 'btn btn-warning btn-sm ms-2';
                        }, 2000);
                    }
                } else {
                    // Error occurred
                    button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                    button.className = 'btn btn-danger btn-sm ms-2';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.className = 'btn btn-warning btn-sm ms-2';
                        button.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Retry error:', error);
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                button.className = 'btn btn-danger btn-sm ms-2';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.className = 'btn btn-warning btn-sm ms-2';
                    button.disabled = false;
                }, 2000);
            });
        }
        
        // Set progress bar widths from data attributes
        function setProgressBarWidths() {
            document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
                const width = bar.getAttribute('data-width');
                if (width) {
                    bar.style.width = width + '%';
                }
            });
        }
        
        // Initialize progress bars on page load
        document.addEventListener('DOMContentLoaded', setProgressBarWidths);
        
        // Auto refresh elke 30 seconden voor multi-host view
        setInterval(() => {
            location.reload();
        }, 30000);

        // Update status badges realtime
        function updateHostStatus() {
            fetch('/api/hosts')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update overall status
                        document.querySelector('.navbar-text').innerHTML = 
                            `<i class="fas fa-chart-line"></i> Infrastructure Health: ${data.overall_status.health_percentage}% (${data.overall_status.online}/${data.overall_status.total} online)`;
                    }
                })
                .catch(error => console.error('Error updating status:', error));
        }

        // Update status elke 10 seconden
        setInterval(updateHostStatus, 10000);
    </script>
</body>
</html>